<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Find jobs in Kenya - errands, cleaning, deliveries, and more on Connect.">
    <meta name="keywords" content="jobs, Kenya, Nairobi, Mombasa, Kisumu, errands, cleaning, delivery">
    <title>Jobs - Connect</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tag {
            @apply bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs cursor-pointer transition-colors;
        }
        .tag:hover {
            @apply bg-gray-300;
        }
        .lazy-load {
            @apply opacity-0 transition-opacity duration-500;
        }
        .lazy-load:not(.lazy-load) {
            @apply opacity-100;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors">
    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-teal-500 to-blue-600 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a class="text-xl font-bold flex items-center" href="/">
                <i class="fas fa-handshake mr-2"></i>Connect
            </a>
            <button id="navbarToggle" class="lg:hidden text-white focus:outline-none" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <div id="navbarMenu" class="hidden lg:flex lg:items-center lg:space-x-6">
                <a class="hover:text-gray-200 transition" href="/">Home</a>
                <a class="hover:text-gray-200 transition" href="jobs.html">Jobs</a>
                <a class="hover:text-gray-200 transition" href="map.html">Map</a>
                <a class="hover:text-gray-200 transition" href="about.html">About</a>
                <a class="hover:text-gray-200 transition" href="contact.html">Contact</a>
                <div id="auth-nav" class="flex items-center space-x-4"></div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden lg:hidden bg-white dark:bg-gray-800 shadow-lg">
        <div class="container mx-auto px-4 py-4 flex flex-col space-y-4">
            <a class="text-gray-800 dark:text-gray-200 hover:text-teal-500 transition" href="/">Home</a>
            <a class="text-gray-800 dark:text-gray-200 hover:text-teal-500 transition" href="jobs.html">Jobs</a>
            <a class="text-gray-800 dark:text-gray-200 hover:text-teal-500 transition" href="map.html">Map</a>
            <a class="text-gray-800 dark:text-gray-200 hover:text-teal-500 transition" href="about.html">About</a>
            <a class="text-gray-800 dark:text-gray-200 hover:text-teal-500 transition" href="contact.html">Contact</a>
            <div id="mobile-auth-nav"></div>
        </div>
    </div>

    <!-- Jobs Section -->
    <section id="jobs" class="container mx-auto px-4 py-12">
        <h2 class="text-3xl font-bold text-gray-800 dark:text-white text-center mb-6" data-i18n="available_jobs">Available Jobs</h2>
        <div id="spotlight" class="bg-gradient-to-r from-teal-50 to-blue-50 dark:from-teal-900 dark:to-blue-900 p-6 rounded-lg mb-6 text-center">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white" id="spotlight-title" data-i18n="category_spotlight"></h3>
            <p class="text-gray-600 dark:text-gray-300" data-i18n="spotlight_desc">Explore top jobs in your area!</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="relative">
                <input type="text" id="searchInput" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-800 dark:text-white dark:border-gray-700" placeholder="Search jobs, skills, or locations..." aria-label="Search jobs">
                <button id="voiceSearch" class="absolute right-3 top-3 text-gray-600 dark:text-gray-300 hover:text-teal-600 dark:hover:text-teal-400" aria-label="Voice search">
                    <i class="fas fa-microphone"></i>
                </button>
                <div id="suggestions" class="absolute bg-white dark:bg-gray-800 border rounded-b-lg w-full max-h-40 overflow-y-auto z-10 hidden"></div>
            </div>
            <select id="categoryFilter" class="p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-800 dark:text-white dark:border-gray-700" aria-label="Filter by category">
                <option value="All">All Categories</option>
                <option value="Errands">Errands</option>
                <option value="Labor">Labor</option>
                <option value="Cleaning">Cleaning</option>
                <option value="Delivery">Delivery</option>
                <option value="Gardening">Gardening</option>
                <option value="Tutoring">Tutoring</option>
                <option value="Painting">Painting</option>
                <option value="Tech Help">Tech Help</option>
            </select>
            <select id="locationFilter" class="p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-800 dark:text-white dark:border-gray-700" aria-label="Filter by location">
                <option value="All">All Locations</option>
                <option value="Nairobi">Nairobi</option>
                <option value="Mombasa">Mombasa</option>
                <option value="Kisumu">Kisumu</option>
            </select>
            <div class="flex items-center">
                <input type="range" id="payRange" min="500" max="5000" value="5000" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700" aria-label="Filter by pay range">
                <span id="payValue" class="ml-2 text-sm text-gray-600 dark:text-gray-300">KES 5000</span>
            </div>
            <select id="urgencyFilter" class="p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-800 dark:text-white dark:border-gray-700" aria-label="Filter by urgency">
                <option value="All">All Urgency</option>
                <option value="Urgent">Urgent</option>
                <option value="Flexible">Flexible</option>
            </select>
            <select id="savedFilter" class="p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-800 dark:text-white dark:border-gray-700" aria-label="Filter by saved jobs">
                <option value="All">All Jobs</option>
                <option value="Saved">Saved Jobs</option>
            </select>
            <select id="tagFilter" class="p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-800 dark:text-white dark:border-gray-700" aria-label="Filter by job type">
                <option value="All">All Types</option>
                <option value="Part-Time">Part-Time</option>
                <option value="Freelance">Freelance</option>
                <option value="Full-Time">Full-Time</option>
            </select>
            <select id="sortFilter" class="p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-800 dark:text-white dark:border-gray-700" aria-label="Sort jobs">
                <option value="default">Sort By</option>
                <option value="price-asc">Price: Low to High</option>
                <option value="price-desc">Price: High to Low</option>
                <option value="rating-desc">Rating: High to Low</option>
                <option value="premium">Premium First</option>
            </select>
            <div class="flex gap-2">
                <button id="resetFilters" class="bg-teal-500 text-white p-3 rounded-lg hover:bg-teal-600 transition" aria-label="Reset filters" data-i18n="reset_filters">Reset</button>
                <div class="relative">
                    <button id="settingsToggle" class="bg-teal-500 text-white p-3 rounded-lg hover:bg-teal-600 transition" aria-label="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div id="settingsMenu" class="absolute hidden right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg z-10">
                        <button id="toggleMap" class="block w-full text-left px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-i18n="map_view">Map View</button>
                        <button id="toggleDarkMode" class="block w-full text-left px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-i18n="dark_mode">Dark Mode</button>
                        <button id="toggleContrast" class="block w-full text-left px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-i18n="high_contrast">High Contrast</button>
                        <button id="exportJobs" class="block w-full text-left px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-i18n="export_jobs">Export as CSV</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-between items-center mb-6">
            <span id="jobCounter" class="text-gray-600 dark:text-gray-300" data-i18n="showing_jobs">Showing 40 jobs</span>
            <select id="languageToggle" class="p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-800 dark:text-white dark:border-gray-700" aria-label="Select language">
                <option value="en">English</option>
                <option value="sw">Swahili</option>
            </select>
        </div>
        <div id="recommendations" class="mb-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
        <div id="map-view" class="h-96 rounded-lg mb-6 hidden"></div>
        <div id="jobs-container" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
        <div class="mt-6 flex justify-center items-center gap-4">
            <button id="prevPage" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition disabled:opacity-50" aria-label="Previous page" data-i18n="previous">Previous</button>
            <span id="pageInfo" class="px-4 py-2 bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-lg">Page 1 - Showing 1-15 of 40 jobs</span>
            <button id="nextPage" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition disabled:opacity-50" aria-label="Next page" data-i18n="next">Next</button>
        </div>
        <div class="mt-4 text-center">
            <button id="subscribeAlerts" class="bg-teal-500 text-white px-6 py-3 rounded-lg hover:bg-teal-600 transition" data-i18n="subscribe_alerts">Subscribe to Job Alerts</button>
        </div>
    </section>

    <!-- Job Alerts Modal -->
    <div id="jobAlertsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" aria-labelledby="jobAlertsModalLabel" aria-hidden="true">
        <div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h5 class="text-xl font-semibold text-gray-800 dark:text-white" id="jobAlertsModalLabel" data-i18n="job_alerts">Job Alerts</h5>
                <button id="closeModal" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="alertsForm">
                <div class="mb-4">
                    <label for="alertCategory" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="category">Category</label>
                    <select id="alertCategory" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-700 dark:text-white dark:border-gray-600" required>
                        <option value="All">All Categories</option>
                        <option value="Errands">Errands</option>
                        <option value="Labor">Labor</option>
                        <option value="Cleaning">Cleaning</option>
                        <option value="Delivery">Delivery</option>
                        <option value="Gardening">Gardening</option>
                        <option value="Tutoring">Tutoring</option>
                        <option value="Painting">Painting</option>
                        <option value="Tech Help">Tech Help</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="alertLocation" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="location">Location</label>
                    <select id="alertLocation" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-700 dark:text-white dark:border-gray-600" required>
                        <option value="All">All Locations</option>
                        <option value="Nairobi">Nairobi</option>
                        <option value="Mombasa">Mombasa</option>
                        <オプション value="Kisumu">Kisumu</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="alertPay" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="min_pay">Minimum Pay (KES)</label>
                    <input type="number" id="alertPay" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 dark:bg-gray-700 dark:text-white dark:border-gray-600" min="500" value="500" required>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="closeModalBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition" data-i18n="close">Close</button>
                    <button type="button" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition" onclick="saveAlerts()" data-i18n="save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-teal-500 to-blue-600 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-lg font-semibold mb-4" data-i18n="connect">Connect</h3>
                    <p class="text-sm" data-i18n="connect_desc">Connecting you with trusted services and job opportunities across Kenya.</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4" data-i18n="links">Links</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="about.html" class="hover:underline" data-i18n="about">About</a></li>
                        <li><a href="contact.html" class="hover:underline" data-i18n="contact">Contact</a></li>
                        <li><a href="faq.html" class="hover:underline" data-i18n="faq">FAQ</a></li>
                        <li><a href="pricing.html" class="hover:underline" data-i18n="pricing">Pricing</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4" data-i18n="services">Services</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="jobs.html?category=cleaning" class="hover:underline" data-i18n="cleaning">Cleaning</a></li>
                        <li><a href="jobs.html?category=delivery" class="hover:underline" data-i18n="delivery">Delivery</a></li>
                        <li><a href="jobs.html?category=errands" class="hover:underline" data-i18n="errands">Errands</a></li>
                        <li><a href="jobs.html?category=tutoring" class="hover:underline" data-i18n="tutoring">Tutoring</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4" data-i18n="follow_us">Follow Us</h3>
                    <div class="flex gap-4">
                        <a href="#" class="hover:text-gray-200"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="hover:text-gray-200"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="hover:text-gray-200"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="hover:text-gray-200"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
            </div>
            <p class="mt-8 text-center text-sm">© 2025 Connect. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Mock job data (same as original)
        const jobs = [
            { id: 1, title: "Boda-boda Delivery", company: "QuickRides", location: "Nairobi", pay: 2000, rating: 4, urgency: "Urgent", premium: true, skills: "Delivery, Navigation", description: "Deliver packages across Nairobi using a boda-boda.", posted: "1 hr ago", category: "Delivery", tags: ["Part-Time", "Freelance"], payUnit: "day" },
            { id: 2, title: "Residential Cleaner", company: "Sparkle Homes", location: "Nairobi", pay: 1500, rating: 5, urgency: "Flexible", premium: false, skills: "Cleaning, Organization", description: "Deep clean homes in upscale Nairobi estates.", posted: "3 hrs ago", category: "Cleaning", tags: ["Part-Time"], payUnit: "day" },
            // ... (remaining job data unchanged)
            { id: 40, title: "Printer Repair Tech", company: "PrintPro", location: "Kisumu", pay: 3700, rating: 4, urgency: "Urgent", premium: false, skills: "Electronics, Repair", description: "Repair office printers for businesses.", posted: "1 hr ago", category: "Tech Help", tags: ["Freelance"], payUnit: "task" }
        ];

        // Mock suggestions
        const suggestions = ["Boda-boda Delivery", "Residential Cleaner", "Nairobi", "Plumbing Fundi", "Math Tutor", "House Painter", "Food Delivery", "Kisumu", "Smartphone Repair", "Garden Trimmer"];

        // Language translations
        const translations = {
            en: {
                available_jobs: "Available Jobs",
                category_spotlight: "Category of the Day: {category}",
                spotlight_desc: "Explore top {category} jobs in your area!",
                previous: "Previous",
                next: "Next",
                subscribe_alerts: "Subscribe to Job Alerts",
                job_alerts: "Job Alerts",
                category: "Category",
                location: "Location",
                min_pay: "Minimum Pay (KES)",
                close: "Close",
                save: "Save",
                reset_filters: "Reset Filters",
                map_view: "Map View",
                dark_mode: "Dark Mode",
                high_contrast: "High Contrast",
                export_jobs: "Export as CSV",
                showing_jobs: "Showing {count} jobs",
                connect: "Connect",
                connect_desc: "Connecting you with trusted services and job opportunities across Kenya.",
                links: "Links",
                about: "About",
                contact: "Contact",
                faq: "FAQ",
                pricing: "Pricing",
                services: "Services",
                cleaning: "Cleaning",
                delivery: "Delivery",
                errands: "Errands",
                tutoring: "Tutoring",
                follow_us: "Follow Us",
                rate_job: "Rate Job",
                recommended_jobs: "Recommended Jobs"
            },
            sw: {
                available_jobs: "Kazi Zinazopatikana",
                category_spotlight: "Kategoria ya Siku: {category}",
                spotlight_desc: "Chunguza kazi za {category} za juu katika eneo lako!",
                previous: "Iliyopita",
                next: "Inayofuata",
                subscribe_alerts: "Jiandikishe kwa Arifa za Kazi",
                job_alerts: "Arifa za Kazi",
                category: "Kategoria",
                location: "Mahali",
                min_pay: "Mshahara wa Chini (KES)",
                close: "Funga",
                save: "Hifadhi",
                reset_filters: "Weka Upya Vichujio",
                map_view: "Mwoneo wa Ramani",
                dark_mode: "Hali ya Giza",
                high_contrast: "Tofauti ya Juu",
                export_jobs: "Hamisha kama CSV",
                showing_jobs: "Inaonyesha kazi {count}",
                connect: "Unganisha",
                connect_desc: "Kukuunganisha na huduma za kuaminika na nafasi za kazi kote Kenya.",
                links: "Viungo",
                about: "Kuhusu",
                contact: "Mawasiliano",
                faq: "Maswali Yanayoulizwa Mara kwa Mara",
                pricing: "Bei",
                services: "Huduma",
                cleaning: "Kusafisha",
                delivery: "Uwasilishaji",
                errands: "Shughuli",
                tutoring: "Kufundisha",
                follow_us: "Tufuate",
                rate_job: "Kadiria Kazi",
                recommended_jobs: "Kazi Zilizopendekezwa"
            }
        };

        // Pagination
        let currentPage = 1;
        const jobsPerPage = [15, 15, 10];

        // Navbar toggle
        document.getElementById("navbarToggle").addEventListener("click", () => {
            const mobileMenu = document.getElementById("mobileMenu");
            mobileMenu.classList.toggle("hidden");
        });

        // Settings menu toggle
        document.getElementById("settingsToggle").addEventListener("click", () => {
            document.getElementById("settingsMenu").classList.toggle("hidden");
        });

        // Modal handling
        document.getElementById("subscribeAlerts").addEventListener("click", () => {
            document.getElementById("jobAlertsModal").classList.remove("hidden");
        });
        document.getElementById("closeModal").addEventListener("click", () => {
            document.getElementById("jobAlertsModal").classList.add("hidden");
        });
        document.getElementById("closeModalBtn").addEventListener("click", () => {
            document.getElementById("jobAlertsModal").classList.add("hidden");
        });

        // Navbar auth state
        function updateAuthNav() {
            const token = localStorage.getItem("token");
            const authNav = document.getElementById("auth-nav");
            const mobileAuthNav = document.getElementById("mobile-auth-nav");
            if (token) {
                fetch("/api/login", {
                    headers: { Authorization: `Bearer ${token}` }
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.user) {
                            authNav.innerHTML = `
                                <div class="relative">
                                    <button class="flex items-center text-white" id="userMenuToggle">
                                        <img src="../assets/img/avatar-placeholder.png" class="rounded-full w-8 h-8" alt="User">
                                    </button>
                                    <div id="userMenu" class="absolute hidden right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg z-10">
                                        <a class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" href="profile.html"><i class="fas fa-user mr-2"></i>Profile</a>
                                        ${data.user.role === "admin" ? '<a class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" href="admin.html"><i class="fas fa-tachometer-alt mr-2"></i>Admin Dashboard</a>' : ""}
                                        <a class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" href="#" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
                                    </div>
                                </div>
                            `;
                            mobileAuthNav.innerHTML = `
                                <a class="text-gray-800 dark:text-gray-200 hover:text-teal-500" href="profile.html"><i class="fas fa-user mr-2"></i>Profile</a>
                                ${data.user.role === "admin" ? '<a class="text-gray-800 dark:text-gray-200 hover:text-teal-500" href="admin.html"><i class="fas fa-tachometer-alt mr-2"></i>Admin Dashboard</a>' : ""}
                                <a class="text-gray-800 dark:text-gray-200 hover:text-teal-500" href="#" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
                            `;
                            document.getElementById("userMenuToggle").addEventListener("click", () => {
                                document.getElementById("userMenu").classList.toggle("hidden");
                            });
                        } else {
                            setLoggedOutNav();
                        }
                    })
                    .catch(() => setLoggedOutNav());
            } else {
                setLoggedOutNav();
            }
        }

        function setLoggedOutNav() {
            document.getElementById("auth-nav").innerHTML = `
                <a class="text-white hover:text-gray-200" href="login.html">Login</a>
                <a class="bg-white text-teal-500 px-3 py-1 rounded-lg hover:bg-gray-100" href="register.html">Sign Up</a>
            `;
            document.getElementById("mobile-auth-nav").innerHTML = `
                <a class="text-gray-800 dark:text-gray-200 hover:text-teal-500" href="login.html">Login</a>
                <a class="text-gray-800 dark:text-gray-200 hover:text-teal-500" href="register.html">Sign Up</a>
            `;
        }

        function logout() {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            updateAuthNav();
            window.location.href = "/";
        }

        // Load jobs
        function loadJobs(page, filteredJobs) {
            const pageIndex = page - 1;
            const jobsThisPage = jobsPerPage[pageIndex] || 10;
            const start = pageIndex === 0 ? 0 : pageIndex === 1 ? 15 : 30;
            const end = start + jobsThisPage;
            const jobsToShow = filteredJobs.slice(start, end);
            const container = document.getElementById("jobs-container");
            container.innerHTML = "";
            jobsToShow.forEach(job => {
                const isBookmarked = localStorage.getItem(`bookmark-${job.id}`) === "true";
                const isApplied = localStorage.getItem(`applied-${job.id}`) === "true";
                const userRating = localStorage.getItem(`rating-${job.id}`) || job.rating;
                container.innerHTML += `
                    <div class="stat-card rounded-lg overflow-hidden ${job.premium ? 'bg-gradient-to-r from-teal-50 to-blue-50 dark:from-teal-900 dark:to-blue-900' : 'bg-white dark:bg-gray-800'} shadow-md hover:shadow-lg transition lazy-load"
                         data-category="${job.category}" data-location="${job.location}" data-pay="${job.pay}"
                         data-rating="${job.rating}" data-urgency="${job.urgency}" data-premium="${job.premium}"
                         data-skills="${job.skills}" data-description="${job.description}" data-company="${job.company}"
                         data-tags="${job.tags.join(',')}">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-semibold text-gray-800 dark:text-white">${job.title}</h3>
                                ${job.premium ? '<span class="bg-yellow-400 text-xs text-black px-2 py-1 rounded">Premium</span>' : ''}
                            </div>
                            <p class="text-gray-600 dark:text-gray-300 text-sm">${job.company} • ${job.location}</p>
                            <p class="text-teal-600 font-bold mt-1">KES ${job.pay}/${job.payUnit}</p>
                            <p class="text-red-600 text-sm mt-1 ${job.urgency === 'Urgent' ? '' : 'hidden'}"><i class="fas fa-exclamation-circle"></i> Urgent</p>
                            <p class="text-yellow-500 text-sm mt-1">${"★".repeat(userRating)}${"☆".repeat(5 - userRating)}</p>
                            <p class="text-green-600 text-sm mt-1 ${isApplied ? '' : 'hidden'}" id="status-${job.id}">Applied</p>
                            <div class="flex flex-wrap gap-2 mt-2">${job.tags.map(tag => `<span class="tag" onclick="filterByTag('${tag}')">${tag}</span>`).join('')}</div>
                            <div class="flex gap-2 mt-4">
                                <button class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition text-sm" onclick="viewDetails(${job.id})">Details</button>
                                <button class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition text-sm" onclick="payMpesa(${job.pay}, ${job.id})">Apply</button>
                                <button class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded-lg text-gray-800 dark:text-gray-200" onclick="bookmarkJob(${job.id})" id="bookmark-${job.id}" aria-label="Bookmark job">${isBookmarked ? "★" : "☆"}</button>
                                <button class="text-teal-600 dark:text-teal-400 text-sm" onclick="shareJob(${job.id})"><i class="fas fa-share-alt"></i></button>
                            </div>
                            ${isApplied ? `
                                <div class="mt-4">
                                    <label for="rate-${job.id}" class="text-sm text-gray-600 dark:text-gray-300" data-i18n="rate_job">Rate Job:</label>
                                    <select id="rate-${job.id}" class="p-1 border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600" onchange="rateJob(${job.id}, this.value)">
                                        <option value="0">Select Rating</option>
                                        <option value="1">★</option>
                                        <option value="2">★★</option>
                                        <option value="3">★★★</option>
                                        <option value="4">★★★★</option>
                                        <option value="5">★★★★★</option>
                                    </select>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            const totalPages = Math.ceil(filteredJobs.length / jobsPerPage[0]);
            document.getElementById("pageInfo").textContent = `Page ${page} - Showing ${start + 1}-${Math.min(end, filteredJobs.length)} of ${filteredJobs.length} jobs`;
            document.getElementById("prevPage").disabled = page === 1;
            document.getElementById("nextPage").disabled = end >= filteredJobs.length || page >= 3;
            document.getElementById("jobCounter").textContent = translations[localStorage.getItem("language") || "en"].showing_jobs.replace("{count}", filteredJobs.length);
            lazyLoadJobs();
            toggleLanguage(localStorage.getItem("language") || "en");
        }

        // Filter and sort jobs
        function filterJobs() {
            const search = document.getElementById("searchInput").value.toLowerCase();
            const category = document.getElementById("categoryFilter").value;
            const location = document.getElementById("locationFilter").value;
            const pay = parseInt(document.getElementById("payRange").value);
            const urgency = document.getElementById("urgencyFilter").value;
            const saved = document.getElementById("savedFilter").value;
            const tag = document.getElementById("tagFilter").value;
            const sort = document.getElementById("sortFilter").value;

            let filteredJobs = jobs.filter(job => {
                const matchesSearch = job.title.toLowerCase().includes(search) ||
                                     job.description.toLowerCase().includes(search) ||
                                     job.skills.toLowerCase().includes(search) ||
                                     job.company.toLowerCase().includes(search);
                const matchesCategory = category === "All" || job.category === category;
                const matchesLocation = location === "All" || job.location === location;
                const matchesPay = job.pay <= pay;
                const matchesUrgency = urgency === "All" || job.urgency === urgency;
                const matchesSaved = saved === "All" || localStorage.getItem(`bookmark-${job.id}`) === "true";
                const matchesTag = tag === "All" || job.tags.includes(tag);
                return matchesSearch && matchesCategory && matchesLocation && matchesPay && matchesUrgency && matchesSaved && matchesTag;
            });

            if (sort === "price-asc") filteredJobs.sort((a, b) => a.pay - b.pay);
            else if (sort === "price-desc") filteredJobs.sort((a, b) => b.pay - a.pay);
            else if (sort === "rating-desc") filteredJobs.sort((a, b) => b.rating - a.rating);
            else if (sort === "premium") filteredJobs.sort((a, b) => b.premium - a.premium);

            currentPage = 1;
            localStorage.setItem("filteredJobs", JSON.stringify(filteredJobs));
            loadJobs(currentPage, filteredJobs);
            updateMap(filteredJobs);
            loadRecommendations(filteredJobs);
        }

        // Reset filters
        document.getElementById("resetFilters").addEventListener("click", () => {
            document.getElementById("searchInput").value = "";
            document.getElementById("categoryFilter").value = "All";
            document.getElementById("locationFilter").value = "All";
            document.getElementById("payRange").value = 5000;
            document.getElementById("payValue").textContent = "KES 5000";
            document.getElementById("urgencyFilter").value = "All";
            document.getElementById("savedFilter").value = "All";
            document.getElementById("tagFilter").value = "All";
            document.getElementById("sortFilter").value = "default";
            filterJobs();
        });

        // Filter by tag
        function filterByTag(tag) {
            document.getElementById("tagFilter").value = tag;
            filterJobs();
        }

        // Lazy load job cards
        function lazyLoadJobs() {
            const jobCards = document.querySelectorAll(".lazy-load");
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.remove("lazy-load");
                        observer.unobserve(entry.target);
                    }
                });
            }, { rootMargin: "50px" });
            jobCards.forEach(card => observer.observe(card));
        }

        // Job recommendations
        function loadRecommendations(filteredJobs) {
            const recentSearches = localStorage.getItem("recentSearches") ? JSON.parse(localStorage.getItem("recentSearches")) : [];
            const savedJobs = jobs.filter(job => localStorage.getItem(`bookmark-${job.id}`) === "true");
            const recommended = [...savedJobs, ...filteredJobs.filter(job => recentSearches.some(s => job.title.toLowerCase().includes(s.toLowerCase())))]
                .filter((job, index, self) => index === self.findIndex(j => j.id === job.id))
                .slice(0, 3);
            const container = document.getElementById("recommendations");
            container.innerHTML = recommended.length ? `
                <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4" data-i18n="recommended_jobs">Recommended Jobs</h3>
                <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    ${recommended.map(job => `
                        <div class="stat-card bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-md">
                            <div class="p-4">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">${job.title} ${job.premium ? '<span class="bg-yellow-400 text-xs text-black ml-2 px-2 py-1 rounded">Premium</span>' : ''}</h3>
                                <p class="text-gray-600 dark:text-gray-300 text-sm">${job.company}</p>
                                <p class="text-teal-600 font-bold">KES ${job.pay}/${job.payUnit}</p>
                                <button class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition mt-2 text-sm" onclick="viewDetails(${job.id})">Details</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '';
        }

        // Map view
        let map, markers = [];
        function init FIBER() {
            map = L.map("map-view").setView([-1.2921, 36.8219], 7);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        }

        function updateMap(filteredJobs) {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            filteredJobs.forEach(job => {
                const coords = {
                    Nairobi: [-1.2921, 36.8219],
                    Mombasa: [-4.0435, 39.6682],
                    Kisumu: [-0.0917, 34.7680]
                }[job.location];
                if (coords) {
                    const marker = L.marker(coords).addTo(map).bindPopup(`${job.title} - ${job.company}`);
                    markers.push(marker);
                }
            });
        }

        // Voice search
        document.getElementById("voiceSearch").addEventListener("click", () => {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = localStorage.getItem("language") === "sw" ? "sw-KE" : "en-US";
            recognition.onresult = event => {
                document.getElementById("searchInput").value = event.results[0][0].transcript;
                const searches = JSON.parse(localStorage.getItem("recentSearches") || "[]");
                searches.unshift(event.results[0][0].transcript);
                localStorage.setItem("recentSearches", JSON.stringify(searches.slice(0, 5)));
                filterJobs();
            };
            recognition.start();
        });

        // Search suggestions
        document.getElementById("searchInput").addEventListener("input", () => {
            const query = document.getElementById("searchInput").value.toLowerCase();
            const suggestionsDiv = document.getElementById("suggestions");
            if (query) {
                const matches = suggestions.filter(s => s.toLowerCase().includes(query));
                suggestionsDiv.innerHTML = matches.map(s => `<div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-gray-800 dark:text-gray-200" onclick="selectSuggestion('${s}')">${s}</div>`).join("");
                suggestionsDiv.classList.remove("hidden");
            } else {
                suggestionsDiv.classList.add("hidden");
            }
        });

        function selectSuggestion(value) {
            document.getElementById("searchInput").value = value;
            document.getElementById("suggestions").classList.add("hidden");
            const searches = JSON.parse(localStorage.getItem("recentSearches") || "[]");
            searches.unshift(value);
            localStorage.setItem("recentSearches", JSON.stringify(searches.slice(0, 5)));
            filterJobs();
        }

        // Toggle map view
        document.getElementById("toggleMap").addEventListener("click", () => {
            const mapView = document.getElementById("map-view");
            const jobsContainer = document.getElementById("jobs-container");
            mapView.classList.toggle("hidden");
            jobsContainer.classList.toggle("hidden");
            if (!mapView.classList.contains("hidden") && !map) initMap();
            filterJobs();
        });

        // Dark mode
        document.getElementById("toggleDarkMode").addEventListener("click", () => {
            document.body.classList.toggle("dark");
            localStorage.setItem("darkMode", document.body.classList.contains("dark"));
        });

        // High contrast
        document.getElementById("toggleContrast").addEventListener("click", () => {
            document.body.classList.toggle("high-contrast");
            localStorage.setItem("highContrast", document.body.classList.contains("high-contrast"));
        });

        // Language toggle
        document.getElementById("languageToggle").addEventListener("change", e => toggleLanguage(e.target.value));
        function toggleLanguage(lang) {
            const categories = ["Cleaning", "Delivery", "Errands", "Labor", "Gardening", "Tutoring", "Painting", "Tech Help"];
            const day = new Date().getDay();
            const spotlightCategory = categories[day % categories.length];
            document.querySelectorAll("[data-i18n]").forEach(el => {
                let text = translations[lang][el.dataset.i18n] || el.textContent;
                if (el.dataset.i18n === "showing_jobs") {
                    const count = document.getElementById("jobCounter").textContent.match(/\d+/) || [jobs.length];
                    text = text.replace("{count}", count[0]);
                } else if (el.dataset.i18n === "category_spotlight") {
                    text = text.replace("{category}", translations[lang][spotlightCategory.toLowerCase()] || spotlightCategory);
                } else if (el.dataset.i18n === "spotlight_desc") {
                    text = text.replace("{category}", translations[lang][spotlightCategory.toLowerCase()] || spotlightCategory);
                }
                el.textContent = text;
            });
            localStorage.setItem("language", lang);
        }

        // Pay range display
        document.getElementById("payRange").addEventListener("input", () => {
            document.getElementById("payValue").textContent = `KES ${document.getElementById("payRange").value}`;
            filterJobs();
        });

        // Pagination
        document.getElementById("prevPage").addEventListener("click", () => {
            if (currentPage > 1) {
                currentPage--;
                filterJobs();
            }
        });

        document.getElementById("nextPage").addEventListener("click", () => {
            if (currentPage < 3) {
                currentPage++;
                filterJobs();
            }
        });

        // Job actions
        function viewDetails(id) {
            window.location.href = `job-details.html?id=${id}`;
        }

        function payMpesa(amount, id) {
            if (!localStorage.getItem("token")) {
                alert("Please log in to apply.");
                window.location.href = "login.html";
                return;
            }
            alert(`Redirecting to M-Pesa for KES ${amount} payment...`);
            localStorage.setItem(`applied-${id}`, "true");
            document.getElementById(`status-${id}`).classList.remove("hidden");
            filterJobs();
        }

        function bookmarkJob(id) {
            const isBookmarked = localStorage.getItem(`bookmark-${id}`) === "true";
            localStorage.setItem(`bookmark-${id}`, !isBookmarked);
            document.getElementById(`bookmark-${id}`).textContent = !isBookmarked ? "★" : "☆";
            filterJobs();
        }

        function shareJob(id) {
            const job = jobs.find(j => j.id === id);
            const text = `Check out this job: ${job.title} in ${job.location} for KES ${job.pay}! Apply on Connect: http://localhost/store-frontia-static/job-details.html?id=${id}`;
            if (navigator.share) {
                navigator.share({ title: job.title, text, url: `http://localhost/store-frontia-static/job-details.html?id=${id}` });
            } else {
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
                window.open(whatsappUrl, "_blank");
            }
        }

        function rateJob(id, rating) {
            if (rating === "0") {
                alert("Please select a valid rating.");
                return;
            }
            localStorage.setItem(`rating-${id}`, rating);
            alert(`Thank you for rating this job ${rating} stars!`);
            filterJobs();
        }

        // Job alerts
        function saveAlerts() {
            const category = document.getElementById("alertCategory").value;
            const location = document.getElementById("alertLocation").value;
            const pay = document.getElementById("alertPay").value;
            if (!category || !location || !pay) {
                alert("Please fill all fields.");
                return;
            }
            localStorage.setItem("jobAlerts", JSON.stringify({ category, location, pay }));
            alert("Job alerts saved!");
            document.getElementById("jobAlertsModal").classList.add("hidden");
        }

        // Export jobs
        document.getElementById("exportJobs").addEventListener("click", () => {
            const filteredJobs = JSON.parse(localStorage.getItem("filteredJobs") || JSON.stringify(jobs));
            const csv = [
                "ID,Title,Company,Location,Pay,Category,Urgency,Skills,Tags,Description,Posted",
                ...filteredJobs.map(job => `${job.id},${job.title},${job.company},${job.location},${job.pay},${job.category},${job.urgency},${job.skills},${job.tags.join(';')},${job.description.replace(/,/g, ';')},${job.posted}`)
            ].join("\n");
            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "connect_jobs.csv";
            a.click();
            URL.revokeObjectURL(url);
        });

        // Initialize
        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem("darkMode") === "true") document.body.classList.add("dark");
            if (localStorage.getItem("highContrast") === "true") document.body.classList.add("high-contrast");
            document.getElementById("searchInput").addEventListener("input", filterJobs);
            document.getElementById("categoryFilter").addEventListener("change", filterJobs);
            document.getElementById("locationFilter").addEventListener("change", filterJobs);
            document.getElementById("payRange").addEventListener("input", filterJobs);
            document.getElementById("urgencyFilter").addEventListener("change", filterJobs);
            document.getElementById("savedFilter").addEventListener("change", filterJobs);
            document.getElementById("tagFilter").addEventListener("change", filterJobs);
            document.getElementById("sortFilter").addEventListener("change", filterJobs);
            updateAuthNav();
            loadJobs(currentPage, jobs);
        });
    </script>
</body>
</html>